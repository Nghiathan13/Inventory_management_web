{% extends 'partials/base.html' %}
<!--  -->
{% load static %}
<!--  -->
{% load crispy_forms_tags %}
<!--  -->
{% block extracss %}
<link rel="stylesheet" href="{% static 'products/css/product.css' %}" />
{% endblock %}
<!--  -->
{% block title %} {{ title }} {% endblock %}
<!--  -->
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <form method="POST" enctype="multipart/form-data">
        <!-- SỬA ĐỔI: THÊM KHỐI HIỂN THỊ LỖI NÀY -->
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
        <!--  -->
        {% csrf_token %}
        <div class="card shadow-sm form-card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h4 class="mb-0">
                {% if form.instance.pk %}<i class="fas fa-edit me-2"></i>Edit Product
                <!--  -->
                {% else %}
                <!--  -->
                <i class="fas fa-plus-circle me-2"></i>Create New Product
                <!--  -->
                {% endif %}
              </h4>
              <div>
                <a href="{% url 'products:list' %}" class="btn btn-secondary btn-sm">CANCEL</a>
                <button class="btn btn-success btn-sm" type="submit"><i class="fas fa-save me-1"></i> SAVE</button>
              </div>
            </div>
          </div>

          <div class="card-body p-4 form-card-body-fixed-height">
            <div class="row">
              <!-- Cột chính bên trái -->
              <div class="col-lg-8">
                <div class="row">
                  <div class="col-md-8">{{ form.name|as_crispy_field }}</div>
                  <div class="col-md-4">{{ form.code|as_crispy_field }}</div>
                </div>
                {{ form.category|as_crispy_field }}
              </div>
              <!-- Cột phụ bên phải (chỉ chứa ảnh) -->
              <div class="col-lg-4">
                <div class="text-center border p-3 rounded h-100">
                  <img
                    id="image-preview"
                    src="{% if form.instance.image %}{{ form.instance.image.url }}{% else %}{% static 'images/default_product.png' %}{% endif %}"
                    class="img-thumbnail mb-2"
                    alt="Image Preview"
                    style="max-height: 150px"
                  />
                  {{ form.image|as_crispy_field }}
                </div>
              </div>
            </div>

            <!-- ======================================================= -->
            <!--        CẤU TRÚC TAB                                     -->
            <!-- ======================================================= -->
            <ul class="nav nav-tabs mt-4" id="productTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="inventory-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#inventory"
                  type="button"
                  role="tab"
                >
                  Inventory & Units
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="pricing-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#pricing"
                  type="button"
                  role="tab"
                >
                  Pricing & Sourcing
                </button>
              </li>
            </ul>
            <div class="tab-content border border-top-0 p-3 rounded-bottom" id="productTabContent">
              <!-- Tab Inventory -->
              <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <div class="row">
                  <div class="col-md-6">{{ form.quantity|as_crispy_field }}</div>
                  <div class="col-md-6">{{ form.reorder_point|as_crispy_field }}</div>
                </div>
                <div class="row">
                  <div class="col-md-6">{{ form.uom_category|as_crispy_field }}</div>
                  <div class="col-md-6">{{ form.base_uom|as_crispy_field }}</div>
                </div>
                {{ form.description|as_crispy_field }}
              </div>

              <!-- Tab Pricing -->
              <div class="tab-pane fade" id="pricing" role="tabpanel">
                <div class="row">
                  <div class="col-md-4">{{ form.import_price|as_crispy_field }}</div>
                  <div class="col-md-4">{{ form.sale_price|as_crispy_field }}</div>
                </div>
                {{ form.supplier|as_crispy_field }}
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
<!--  -->
{% block javascript %}
<!--  -->
{{ uoms_by_category|json_script:"uoms-by-category" }}
<script src="{% static 'products/js/product_form.js' %}"></script>
{% endblock %}
