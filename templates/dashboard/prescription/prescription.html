{% extends 'partials/base.html' %} {% load crispy_forms_tags %}
<!---->
{% load static %}
<!---->
{% block extracss %}
<link rel="stylesheet" href="{% static 'css/dashboard/prescription.css' %}" />
{% endblock %}
<!---->
{% block title %} Kê Đơn Thuốc {% endblock %}
<!---->
{% block content %}
<div class="container">
  <!-- ALERT -->
  <div class="row">
    <div class="col">
      {% if messages %} {% for message in messages %}
      <div
        class="alert alert-{{ message.tags }} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %}
    </div>
  </div>

  <!-- FORM KÊ ĐƠN -->
  <div class="row">
    <div class="card shadow-sm">
      <div class="card-header">
        <p><i class="fa-solid fa-file-medical"></i> New Prescription</p>
      </div>
      <div class="card-body">
        <!-- Patient -->
        <p>Patient <span class="required">*</span></p>
        <form
          method="POST"
          id="prescription-form"
          onsubmit="return confirm('Are you sure you want to complete and dispatch this prescription? This action cannot be undone.');"
        >
          {% csrf_token %}
          <!-- Dòng này sẽ tự động render ô chọn Bệnh nhân và trường Bác sĩ (đã bị ẩn) -->
          {{ prescription_form|crispy }}

          <hr />
          <!-- Medicine Details -->
          <p>Medicine Details <span class="required">*</span></p>
          <div id="details-container">
            <!-- Form details will be added here by JS -->
          </div>

          <template id="detail-form-template">
            <div
              class="row mb-3 detail-form align-items-end"
              data-index="__prefix__"
            >
              <div class="col-md-5">
                <label for="id_details___prefix___product">Name</label>
                <select
                  name="details-__prefix__-product"
                  id="id_details___prefix___product"
                  class="form-control"
                  required
                >
                  <option value="">---------</option>
                  <!-- Options will be populated by JS -->
                </select>
              </div>
              <div class="col-md-5">
                <label for="id_details___prefix___quantity">Quantity</label>
                <input
                  type="number"
                  name="details-__prefix__-quantity"
                  id="id_details___prefix___quantity"
                  class="form-control"
                  min="1"
                  required
                />
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-form w-100">
                  <i class="fa-solid fa-trash"></i>
                  Delete
                </button>
              </div>
            </div>
          </template>

          <!-- This hidden input is VERY IMPORTANT for the view to know how many forms are submitted -->
          <input type="hidden" name="form_count" id="form-count" value="0" />
          <hr />

          <!-- Button -->
          <div class="mt-3">
            <button type="button" id="add-more" class="btn btn-secondary">
              <i class="fa-solid fa-plus"></i> Add
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fa-solid fa-check-circle"></i> Complete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- LỊCH SỬ TOA THUỐC -->
  <div class="row">
    <div class="card shadow-sm">
      <div class="card-header">
        <p><i class="fa-solid fa-clock-rotate-left"></i> History</p>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="thead-light">
              <tr>
                <th>ID</th>
                <th>Patient</th>
                <th>Doctor</th>
                <th>Created Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prescriptions %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.patient.full_name|default:"N/A" }}</td>
                <td>{{ p.doctor.username }}</td>
                <td>{{ p.created_at|date:"d/m/Y H:i" }}</td>
                <td>
                  {% if p.completed_at %}
                  <span class="badge bg-success"
                    >Đã hoàn tất lúc {{ p.completed_at|date:"H:i d/m/Y" }}</span
                  >
                  {% else %}
                  <span class="badge bg-warning">Chưa hoàn tất</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">
                  Chưa có toa thuốc nào được tạo.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<!---->
{% block javascript %}
<script src="{% static 'js/dashboard/prescription.js' %}"></script>
<script>
  // Truyền dữ liệu từ Django sang JavaScript
  const productsData = [
      {% for product in products %}
      { id: '{{ product.id }}', name: '{{ product.name|escapejs }} (Còn: {{product.quantity}})' },
      {% endfor %}
  ];
  // Gọi hàm khởi tạo với dữ liệu
  initializePrescriptionForm(productsData);
</script>
{% endblock %}
