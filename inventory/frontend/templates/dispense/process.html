{% extends 'partials/base.html' %}
<!--  -->
{% load static %}
<!--  -->
{% block title %} Dispense #{{ prescription.id }} {% endblock %}
<!--  -->
{% block extracss %}
<link rel="stylesheet" href="{% static 'dispense/css/process_dispense.css' %}" />
{% endblock %}
<!--  -->
{% block content %}
<div class="container-fluid mt-4 pb-5">
  <!-- HEADER TRANG -->
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h3 class="fw-bold text-black m-0">
      <i class="fas fa-pills me-2 icon-black"></i>Process Prescription #{{ prescription.id }}
    </h3>
    <a href="{% url 'inventory:dispense_list' %}" class="btn btn-secondary" id="btn-back-top">
      <i class="fas fa-arrow-left me-1"></i> Back to List
    </a>
  </div>

  <div class="row row-equal-height">
    <!-- ========================================== -->
    <!--       CỘT TRÁI: THÔNG TIN CHI TIẾT       -->
    <!-- ========================================== -->
    <div class="col-lg-7 mb-4 d-flex flex-column">
      <div class="card h-100 card-strong-border">
        <!-- Header Tím -->
        <div class="card-header card-header-purple">
          <h4><i class="fas fa-file-medical-alt me-2"></i>Prescription Details</h4>
        </div>

        <div class="card-body p-4">
          <!-- Thông tin bệnh nhân & Bác sĩ -->
          <div class="row mb-4 p-3 bg-light rounded border border-secondary mx-0">
            <div class="col-md-6 border-end border-secondary">
              <small class="text-uppercase text-muted fw-bold">Patient</small>
              <p class="fs-5 fw-bold text-black mb-0">{{ prescription.patient.full_name }}</p>
            </div>
            <div class="col-md-6 ps-md-4">
              <small class="text-uppercase text-muted fw-bold">Prescribed By</small>
              <p class="fs-5 fw-bold text-black mb-0">Dr. {{ prescription.doctor.username }}</p>
              <small class="text-muted"
                ><i class="far fa-clock me-1"></i> {{ prescription.created_at|date:"d/m/Y H:i" }}</small
              >
            </div>
          </div>

          <h6 class="text-black mb-3 fw-bold">Medication List (Reference):</h6>
          <div class="table-responsive">
            <!-- Bảng viền đậm -->
            <table class="table table-bordered-strong table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th class="py-2 ps-3 text-black">Product Name</th>
                  <th class="py-2 text-center text-black">Request Qty</th>
                  <th class="py-2 text-center text-black">Total Stock</th>
                </tr>
              </thead>
              <tbody>
                {% for detail in prescription.details.all %}
                <tr>
                  <!-- Tên thuốc màu đen -->
                  <td class="text-start ps-3 fw-bold text-black">{{ detail.product.name }}</td>
                  <td class="text-center">
                    <span class="badge bg-light text-dark border border-dark px-3 py-2">
                      {{ detail.quantity }} {{ detail.uom.name }}
                    </span>
                  </td>
                  <td class="text-center text-dark">
                    <strong>{{ detail.product.quantity }}</strong> {{ detail.product.base_uom.name }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer Cột Trái: Nút Hoàn thành (Submit Form) -->
        <div class="card-footer bg-white p-3 border-top border-secondary">
          <div class="d-flex justify-content-end align-items-center">
            <form method="POST" id="finish-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-secondary btn-lg px-4" id="btn-complete" disabled>
                <i class="fas fa-check-double me-2"></i> Complete & Finish
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================================== -->
    <!--       CỘT PHẢI: TRỢ LÝ LẤY THUỐC         -->
    <!-- ========================================== -->
    <div class="col-lg-5 mb-4 d-flex flex-column">
      <div class="card h-100 card-strong-border bg-light" style="min-height: 600px">
        <!-- Header Tím -->
        <div class="card-header card-header-purple d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Picking Assistant</h5>
          <!-- Nút Start Picking -->
          <button class="btn btn-light text-dark btn-sm fw-bold px-3 shadow-sm" id="btn-start-picking">
            <span class="js-btn-text"><i class="fas fa-play me-1 icon-black"></i> START</span>
            <span class="js-btn-loading d-none"
              ><span class="spinner-border spinner-border-sm"></span> Loading...</span
            >
          </button>
        </div>

        <div class="card-body d-flex flex-column p-0">
          <!-- 1. Panel Trạng Thái Kệ -->
          <div class="p-3 bg-white border-bottom border-secondary shadow-sm z-index-1 position-relative">
            <div class="d-flex align-items-center justify-content-center">
              <div class="text-center me-4">
                <small class="text-uppercase fw-bold d-block text-black" style="font-size: 0.75rem"
                  >Current Shelf</small
                >
                <span id="current-shelf-display" class="display-6 fw-bold text-black">--</span>
              </div>
              <div class="vr h-100 mx-3"></div>
              <div>
                <!-- 3 Trạng thái riêng biệt để JS điều khiển ẩn hiện -->
                <span
                  id="status-idle"
                  class="badge bg-secondary px-3 py-2 rounded-pill border border-dark text-white"
                >
                  <i class="fas fa-pause me-1"></i> Idle
                </span>
                <span
                  id="status-moving"
                  class="badge bg-warning text-dark px-3 py-2 rounded-pill border border-dark d-none"
                >
                  <i class="fas fa-sync fa-spin me-1"></i> Moving...
                </span>
                <span
                  id="status-ready"
                  class="badge bg-success px-3 py-2 rounded-pill border border-dark text-white d-none"
                >
                  <i class="fas fa-check me-1"></i> Ready
                </span>
              </div>
            </div>
          </div>

          <!-- 2. Danh sách hàng chờ (Queue) -->
          <div
            id="picking-queue"
            class="flex-grow-1 p-3 overflow-auto custom-scrollbar"
            style="background-color: #e9ecef"
          >
            <div class="text-center text-muted py-5 mt-5 js-placeholder">
              <div class="mb-3"><i class="fas fa-box-open fa-4x text-secondary opacity-25"></i></div>
              <h5>Ready to Dispense</h5>
              <p class="small">Click <strong>"START"</strong> to calculate optimized path.</p>
            </div>
          </div>
        </div>

        <div
          class="card-footer bg-white text-center text-muted py-2 border-top border-secondary"
          style="font-size: 0.8rem"
        >
          <i class="fas fa-info-circle me-1"></i> Picking items will automatically deduct stock.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================= -->
<!--    TEMPLATE ITEM (BLUEPRINT CHO JS)                      -->
<!-- ======================================================= -->
<template id="picking-item-template">
  <div class="picking-item p-3 mb-2 rounded">
    <div class="d-flex justify-content-between align-items-start">
      <!-- Cột Trái: Thông tin -->
      <div class="me-2" style="flex: 1">
        <div class="d-flex align-items-center mb-1">
          <!-- Icon trạng thái -->
          <span class="me-2 fs-5 js-icon-pending d-none"><i class="far fa-circle text-secondary"></i></span>
          <span class="me-2 fs-5 js-icon-active d-none"
            ><i class="fas fa-spinner fa-spin" style="color: rgb(100, 55, 195)"></i
          ></span>
          <span class="me-2 fs-5 js-icon-done d-none"><i class="fas fa-check-circle text-success"></i></span>

          <!-- Tên thuốc (Màu đen) -->
          <h6 class="mb-0 fw-bold text-black js-product-name product-name"></h6>
        </div>

        <div class="small text-dark ms-4">
          <div>
            <i class="fas fa-map-marker-alt me-1 icon-black"></i>
            Kệ <strong class="js-item-shelf"></strong> - Tầng <strong class="js-item-level"></strong>
          </div>
          <!-- Số lượng tồn trên kệ -->
          <div class="fw-bold mt-1" style="font-size: 0.85rem; color: rgb(100, 55, 195)">
            <i class="fas fa-cubes me-1"></i> Available: <span class="js-stock-at-shelf"></span>
          </div>
          <div class="text-muted mt-1" style="font-size: 0.8rem">
            <i class="fas fa-barcode me-1"></i> Batch: <span class="js-item-batch"></span>
            <span class="ms-1">(HSD: <span class="js-item-expiry"></span>)</span>
          </div>

          <!-- QUAN TRỌNG: Class này để JS hiển thị khi tách lô -->
          <div class="text-warning fst-italic d-none js-split-msg mt-1" style="font-size: 0.8rem">
            <i class="fas fa-arrow-right me-1"></i> Not enough! Next shelf...
          </div>
        </div>
      </div>

      <!-- Cột Phải: Nút bấm -->
      <div class="text-end" style="min-width: 130px">
        <!-- Badge số lượng cần lấy -->
        <div class="badge fs-6 mb-2 px-3 py-2 rounded-pill" style="background-color: rgb(100, 55, 195)">
          Pick: <span class="js-item-quantity"></span>
        </div>

        <div class="action-area mt-1">
          <!-- Nút Confirm (Lấy thuốc) -->
          <button
            class="btn btn-primary btn-sm w-100 shadow-sm js-btn-confirm d-none"
            style="background-color: rgb(100, 55, 195); border-color: rgb(100, 55, 195)"
          >
            <span class="js-text-confirm"><i class="fas fa-hand-holding-medical me-1"></i> Confirm</span>
            <span class="js-text-wait d-none"><i class="fas fa-sync fa-spin"></i> Wait...</span>
          </button>

          <!-- Nút Undo -->
          <button class="btn btn-warning btn-sm w-100 mt-1 shadow-sm js-btn-undo d-none">
            <i class="fas fa-undo-alt me-1"></i> Undo
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

{% endblock %}
<!--  -->
{% block javascript %}
<script>
  const PRESCRIPTION_ID = {{ prescription.id }};
  const URLS = {
      calcPath: "{% url 'inventory:api_calculate_picking_path' prescription.id %}",
      confirmPick: "{% url 'inventory:api_confirm_pick' %}",
      undoPick: "{% url 'inventory:api_undo_pick' %}",
      moveCarousel: "{% url 'carousel:api_move_to_shelf' %}",
      carouselStatus: "{% url 'carousel:api_get_status' %}"
  };
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>
<script src="{% static 'dispense/js/dispense_logic.js' %}"></script>
{% endblock %}
